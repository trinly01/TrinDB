!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TrinDB=t():e.TrinDB=t()}(global,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=5)}([function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("stream")},function(e,t,r){var n=r(1);function o(e,t,r){e=e||function(e){this.queue(e)},t=t||function(){this.queue(null)};var o=!1,a=!1,i=[],u=!1,c=new n;function s(){for(;i.length&&!c.paused;){var e=i.shift();if(null===e)return c.emit("end");c.emit("data",e)}}function f(){c.writable=!1,t.call(c),!c.readable&&c.autoDestroy&&c.destroy()}return c.readable=c.writable=!0,c.paused=!1,c.autoDestroy=!(r&&!1===r.autoDestroy),c.write=function(t){return e.call(this,t),!c.paused},c.queue=c.push=function(e){return u||(null===e&&(u=!0),i.push(e),s()),c},c.on("end",(function(){c.readable=!1,!c.writable&&c.autoDestroy&&process.nextTick((function(){c.destroy()}))})),c.end=function(e){if(!o)return o=!0,arguments.length&&c.write(e),f(),c},c.destroy=function(){if(!a)return a=!0,o=!0,i.length=0,c.writable=c.readable=!1,c.emit("close"),c},c.pause=function(){if(!c.paused)return c.paused=!0,c},c.resume=function(){return c.paused&&(c.paused=!1,c.emit("resume")),s(),c.paused||c.emit("drain"),c},c}e.exports=o,o.through=o},function(e,t,r){var n=r(1),o=["write","end","destroy"],a=["resume","pause"],i=["data","close"],u=Array.prototype.slice;function c(e,t){if(e.forEach)return e.forEach(t);for(var r=0;r<e.length;r++)t(e[r],r)}e.exports=function(e,t){var r=new n,s=!1;return c(o,(function(t){r[t]=function(){return e[t].apply(e,arguments)}})),c(a,(function(e){r[e]=function(){r.emit(e);var n=t[e];if(n)return n.apply(t,arguments);t.emit(e)}})),c(i,(function(e){t.on(e,(function(){var t=u.call(arguments);t.unshift(e),r.emit.apply(r,t)}))})),t.on("end",(function(){if(s)return;s=!0;var e=u.call(arguments);e.unshift("end"),r.emit.apply(r,e)})),e.on("drain",(function(){r.emit("drain")})),e.on("error",f),t.on("error",f),r.writable=e.writable,r.readable=t.readable,r;function f(e){r.emit("error",e)}}},function(e,t,r){"use strict";r.r(t),r.d(t,"v1",(function(){return p})),r.d(t,"v3",(function(){return y})),r.d(t,"v4",(function(){return h})),r.d(t,"v5",(function(){return v}));var n=r(0),o=r.n(n);function a(){return o.a.randomBytes(16)}for(var i=[],u=0;u<256;++u)i[u]=(u+256).toString(16).substr(1);var c,s,f=function(e,t){var r=t||0,n=i;return[n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],"-",n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]],n[e[r++]]].join("")},d=0,l=0;var p=function(e,t,r){var n=t&&r||0,o=t||[],i=(e=e||{}).node||c,u=void 0!==e.clockseq?e.clockseq:s;if(null==i||null==u){var p=e.random||(e.rng||a)();null==i&&(i=c=[1|p[0],p[1],p[2],p[3],p[4],p[5]]),null==u&&(u=s=16383&(p[6]<<8|p[7]))}var m=void 0!==e.msecs?e.msecs:(new Date).getTime(),y=void 0!==e.nsecs?e.nsecs:l+1,h=m-d+(y-l)/1e4;if(h<0&&void 0===e.clockseq&&(u=u+1&16383),(h<0||m>d)&&void 0===e.nsecs&&(y=0),y>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");d=m,l=y,s=u;var v=(1e4*(268435455&(m+=122192928e5))+y)%4294967296;o[n++]=v>>>24&255,o[n++]=v>>>16&255,o[n++]=v>>>8&255,o[n++]=255&v;var g=m/4294967296*1e4&268435455;o[n++]=g>>>8&255,o[n++]=255&g,o[n++]=g>>>24&15|16,o[n++]=g>>>16&255,o[n++]=u>>>8|128,o[n++]=255&u;for(var b=0;b<6;++b)o[n+b]=i[b];return t||f(o)};var m=function(e,t,r){var n=function(e,n,o,a){var i=o&&a||0;if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=new Array(e.length),r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}(e)),"string"==typeof n&&(n=function(e){var t=[];return e.replace(/[a-fA-F0-9]{2}/g,(function(e){t.push(parseInt(e,16))})),t}(n)),!Array.isArray(e))throw TypeError("value must be an array of bytes");if(!Array.isArray(n)||16!==n.length)throw TypeError("namespace must be uuid string or an Array of 16 byte values");var u=r(n.concat(e));if(u[6]=15&u[6]|t,u[8]=63&u[8]|128,o)for(var c=0;c<16;++c)o[i+c]=u[c];return o||f(u)};try{n.name=e}catch(e){}return n.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",n.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",n};var y=m("v3",48,(function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),o.a.createHash("md5").update(e).digest()}));var h=function(e,t,r){var n=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||a)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var i=0;i<16;++i)t[n+i]=o[i];return t||f(o)};var v=m("v5",80,(function(e){return Array.isArray(e)?e=Buffer.from(e):"string"==typeof e&&(e=Buffer.from(e,"utf8")),o.a.createHash("sha1").update(e).digest()}))},function(e,t,r){const n=r(6);e.exports=async e=>await new Promise((t,r)=>{try{n(e,e=>{t(e)})}catch(e){r(e)}})},function(e,t,r){const n=r(7),o=r(15),a=r(16),{v4:i}=r(4),u=i;let c=new Function("try {return this===window;}catch(e){ return false;}");const s=c()?{}:r(18),f=c()?{}:r(19),d=r(20);e.exports=({filename:e="test.db",inMemoryOnly:t=!1,pagination:r={limit:10},restful:i},c)=>{const l={};let p=0,m=null;if(t)return m=a({total:p,data:l},{mrDot:o,inMemoryOnly:t,pagination:r}),i&&d(i,m),void c(m);const y=f.resolve(process.cwd()+"/"+e);if(!s.existsSync(y)){const e=y.split(/(\\|\/)/);e.pop();const t=e.join("/");s.existsSync(t)||s.mkdirSync(t),s.writeFileSync(y,"")}let h=s.createWriteStream(y,{flags:"a",encoding:"utf8"});m=a({total:p,data:l},{fs:s,path:y,mrDot:o,inMemoryOnly:t,pagination:r,fileWriteStream:h});const v=s.createReadStream(y,{encoding:"utf8"});v.pipe(n.split()).pipe(n.mapSync(e=>{if(""!==e){const t=JSON.parse(e);switch(t.action||(t._id=t._id||u(),t={action:"create",data:t}),t.action){case"create":p+=1,l[t.data._id]=t.data;break;case"patch":for(const e in t.data)o(l[t.data._id],e,t.data[e]);break;case"remove":p-=1,delete l[t.data._id];break;case"deleteProps":for(const e in t.data)if("_id"!==e){const r=e.split("."),n=r.pop();delete o(l[t.data._id],r)[n]}break;case"inc":for(const e in t.data)if("_id"!==e){const r=o(l[t.data._id],e)+t.data[e];o(l[t.data._id],e,r)}break;case"splice":for(const e in t.data)"_id"!==e&&o(l[t.data._id],e).splice(t.data[e],1);break;case"concat":for(const e in t.data)if("_id"!==e){let r=o(l[t.data._id],e);r.push.apply(r,t.data[e])}break;default:for(const e in t.data)"_id"!==e&&o(l[t.data._id],e)[t.action](t.data[e])}}}).on("end",()=>{i&&d(i,m),v.close(),m.compact(),c(m)}))}},function(e,t,r){var n=r(1).Stream,o=t,a=r(2),i=r(8),u=r(3),c=r(9),s=r(10),f=r(11),d=r(13),l=global.setImmediate||process.nextTick;o.Stream=n,o.through=a,o.from=i,o.duplex=u,o.map=c,o.pause=s,o.split=f,o.pipeline=o.connect=o.pipe=d,o.concat=o.merge=function(){var e=[].slice.call(arguments);1===e.length&&e[0]instanceof Array&&(e=e[0]);var t=new n;t.setMaxListeners(0);var r=0;return t.writable=t.readable=!0,e.length?e.forEach((function(n){n.pipe(t,{end:!1});var o=!1;n.on("end",(function(){o||(o=!0,++r==e.length&&t.emit("end"))}))})):process.nextTick((function(){t.emit("end")})),t.write=function(e){this.emit("data",e)},t.destroy=function(){e.forEach((function(e){e.destroy&&e.destroy()}))},t},o.collect=o.writeArray=function(e){if("function"!=typeof e)throw new Error("function writeArray (done): done must be function");var t=new n,r=[],o=!1;return t.write=function(e){r.push(e)},t.end=function(){o=!0,e(null,r)},t.writable=!0,t.readable=!1,t.destroy=function(){t.writable=t.readable=!1,o||e(new Error("destroyed before end"),r)},t},o.readArray=function(e){var t=new n,r=0,o=!1,a=!1;if(t.readable=!0,t.writable=!1,!Array.isArray(e))throw new Error("event-stream.read expects an array");return t.resume=function(){if(!a){o=!1;for(var n=e.length;r<n&&!o&&!a;)t.emit("data",e[r++]);r!=n||a||(a=!0,t.readable=!1,t.emit("end"))}},process.nextTick(t.resume),t.pause=function(){o=!0},t.destroy=function(){a=!0,t.emit("close")},t},o.readable=function(e,t){var r=new n,o=0,a=!1,i=!1,u=!1;if(r.readable=!0,r.writable=!1,"function"!=typeof e)throw new Error("event-stream.readable expects async function");function c(n,s){n?(r.emit("error",n),t||r.emit("end")):arguments.length>1&&r.emit("data",s),l((function(){if(!(i||a||u))try{u=!0,e.call(r,o++,(function(){u=!1,c.apply(null,arguments)}))}catch(e){r.emit("error",e)}}))}return r.on("end",(function(){i=!0})),r.resume=function(){a=!1,c()},process.nextTick(c),r.pause=function(){a=!0},r.destroy=function(){r.emit("end"),r.emit("close"),i=!0},r},o.mapSync=function(e){return o.through((function(t){var r;try{r=e(t)}catch(e){return this.emit("error",e)}void 0!==r&&this.emit("data",r)}))},o.filterSync=function(e){return o.through((function(t){e(t)&&this.queue(t)}))},o.flatmapSync=function(e){return o.through((function(t){var r=this;t.forEach((function(t){r.queue(e(t))}))}))},o.log=function(e){return o.through((function(t){[].slice.call(arguments);e?console.error(e,t):console.error(t),this.emit("data",t)}))},o.child=function(e){return o.duplex(e.stdin,e.stdout)},o.parse=function(e){var t=!(!e||!e.error);return o.through((function(e){var r;try{e&&(r=JSON.parse(e.toString()))}catch(r){return t?this.emit("error",r):console.error(r,"attempting to parse:",e)}void 0!==r&&this.emit("data",r)}))},o.stringify=function(){var e=r(14).Buffer;return o.mapSync((function(t){return JSON.stringify(e.isBuffer(t)?t.toString():t)+"\n"}))},o.replace=function(e,t){return o.pipeline(o.split(e),o.join(t))},o.join=function(e){if("function"==typeof e)return o.wait(e);var t=!0;return o.through((function(r){return t||this.emit("data",e),t=!1,this.emit("data",r),!0}))},o.wait=function(e){var t=[];return o.through((function(e){t.push(e)}),(function(){var r=Buffer.isBuffer(t[0])?Buffer.concat(t):t.join("");this.emit("data",r),this.emit("end"),e&&e(null,r)}))},o.pipeable=function(){throw new Error("[EVENT-STREAM] es.pipeable is deprecated")}},function(e,t,r){"use strict";var n=r(1);e.exports=function e(t){if(Array.isArray(t)){var r=0,o=t.length;return e((function(e){return r<o?this.emit("data",t[r++]):this.emit("end"),!0}))}var a=new n,i=0;function u(){if(a.started=!0,!a.ended)for(;!a.ended&&!a.paused&&t.call(a,i++,(function(){a.ended||a.paused||process.nextTick(u)})););}return a.ended=!1,a.started=!1,a.readable=!0,a.writable=!1,a.paused=!1,a.ended=!1,a.pause=function(){a.started=!0,a.paused=!0},a.resume=function(){a.started=!0,a.paused=!1,u()},a.on("end",(function(){a.ended=!0,a.readable=!1,process.nextTick(a.destroy)})),a.destroy=function(){a.ended=!0,a.emit("close")},process.nextTick((function(){a.started||a.resume()})),a}},function(e,t,r){var n=r(1).Stream;e.exports=function(e,t){var r=new n,o=0,a=0,i=!1,u=!1,c=!1,s=0,f=!1,d=(t=t||{}).failures?"failure":"error",l={};function p(e,t){var n=s+1;if(t===n?(void 0!==e&&r.emit.apply(r,["data",e]),s++,n++):l[t]=e,l.hasOwnProperty(n)){var c=l[n];return delete l[n],p(c,n)}a++,o===a&&(u&&(u=!1,r.emit("drain")),i&&y())}function m(e,n,o){c||(f=!0,e&&!t.failures||p(n,o),e&&r.emit.apply(r,[d,e]),f=!1)}function y(e){if(i=!0,r.writable=!1,void 0!==e)return p(e,o);o==a&&(r.readable=!1,r.emit("end"),r.destroy())}return r.writable=!0,r.readable=!0,r.write=function(t){if(i)throw new Error("map stream is not writable");f=!1,o++;try{var r=(n=t,a=o,c=m,e.call(null,n,(function(e,t){c(e,t,a)})));return!(u=!1===r)}catch(e){if(f)throw e;return m(e),!u}var n,a,c},r.end=function(e){i||y(e)},r.destroy=function(){i=c=!0,r.writable=r.readable=u=!1,process.nextTick((function(){r.emit("close")}))},r.pause=function(){u=!0},r.resume=function(){u=!1},r}},function(e,t,r){e.exports=r(2)},function(e,t,r){var n=r(2),o=r(12).StringDecoder;e.exports=function(e,t,r){var a=new o,i="",u=r&&r.maxLength,c=!r||!1!==r.trailing;"function"==typeof e&&(t=e,e=null);e||(e=/\r?\n/);function s(e,r){if(t){try{r=t(r)}catch(t){return e.emit("error",t)}void 0!==r&&e.queue(r)}else e.queue(r)}function f(t,r){var n=((null!=i?i:"")+r).split(e);if(i=n.pop(),u&&i.length>u)return t.emit("error",new Error("maximum buffer reached"));for(var o=0;o<n.length;o++){s(t,n[o])}}return n((function(e){f(this,a.write(e))}),(function(){a.end&&f(this,a.end()),c&&null!=i&&s(this,i),this.queue(null)}))}},function(e,t){e.exports=require("string_decoder")},function(e,t,r){var n=r(3),o=r(2);e.exports=function(){var e;if(0==(e=1==arguments.length&&Array.isArray(arguments[0])?arguments[0]:[].slice.call(arguments)).length)return o();if(1==e.length)return e[0];var t=e[0],r=e[e.length-1],a=n(t,r);function i(e){e.length<2||(e[0].pipe(e[1]),i(e.slice(1)))}function u(){var e=[].slice.call(arguments);e.unshift("error"),a.emit.apply(a,e)}i(e);for(var c=1;c<e.length-1;c++)e[c].on("error",u);return a}},function(e,t){e.exports=require("buffer")},function(e,t){e.exports=function e(t,r,n){try{return"string"==typeof r?e(t,r.split("."),n):1==r.length&&void 0!==n?t[r[0]]=n:0==r.length?t:e(t[r[0]],r.slice(1),n)}catch(e){return}}},function(e,t,r){const{v4:n}=r(4),o=n,a=r(17);e.exports=(e,{fs:t,path:r,mrDot:n,inMemoryOnly:i,pagination:u,fileWriteStream:c})=>{const s=(e,t,r)=>{const n={action:t,data:r};if(!i){const e=JSON.stringify(n);c.write(`${e}\r\n`)}return n};return{pagination:u,get:(t,r)=>e.data[t]?(r=r||(e=>{objreturn}))(JSON.parse(JSON.stringify(e.data[t]))):{code:404,message:"Record Not Found"},create:t=>(e.total=e.total+1,t._id=t._id||o(),e.data[t._id]=t,s(0,"create",t)),patch(t,r){if(!e.data[t])return{code:404,message:"Record Not Found"};for(const o in r)n(e.data[t],o,r[o]);return r._id=t,s(0,"patch",r)},remove(t){if(!e.data[t])return{code:404,message:"Record Not Found"};return e.total=e.total-1,delete e.data[t],s(0,"remove",{_id:t})},deleteProps(t,r){if(!e.data[t])return{code:404,message:"Record Not Found"};r._id=t;for(const o in r)if("_id"!==o&&!0===r[o]){const r=o.split("."),a=r.pop();delete n(e.data[t],r)[a]}return s(0,"deleteProps",r)},inc(t,r){if(!e.data[t])return{code:404,message:"Record Not Found"};r._id=t;for(const o in r)if("_id"!==o){const a=+n(e.data[t],o)+ +r[o];n(e.data[t],o,a)}return s(0,"inc",r)},splice(t,r){if(!e.data[t])return{code:404,message:"Record Not Found"};r._id=t;for(const o in r)"_id"!==o&&n(e.data[t],o).splice(r[o],1);JSON.stringify({action:"splice",data:r});return s(0,"splice",r)},concat(t,r){if(!e.data[t])return{code:404,message:"Record Not Found"};r._id=t;for(const o in r)if("_id"!==o){let a=n(e.data[t],o);a.push.apply(a,r[o])}return s(0,"concat",r)},arrayFunction(t,r,o){if(!e.data[r])return{code:404,message:"Record Not Found"};o._id=r;for(const a in o)"_id"!==a&&n(e.data[r],a)[t](o[a]);return s(0,t,o)},push(e,t){return this.arrayFunction("push",e,t)},unshift(e,t){return this.arrayFunction("unshift",e,t)},compact(n=r,o=e.data){t.writeFileSync(r,"",{encoding:"utf8"});for(const e in o)s(0,"create",o[e]);return n},search(t,r={}){let n=r.map||(e=>e);const o={};let i=null,c=0;for(const r in e.data){const i=e.data[r],u=a(t,i);if(u._score){c+=1;let e=n(u);o[r]=e}}return i=this.sort({data:o,params:{_score:-1}}),u?this.paginate({total:c,data:i,...r}):{total:c,data:i}},sort({data:t=e.data,params:r}){const o={},a=Object.keys(t);a.sort((e,o)=>{if("function"==typeof r)return r(t[e],t[o]);for(const a in r){let i=n(t[e],a),u=n(t[o],a);if("string"==typeof i&&"string"==typeof u&&(i=i.toLowerCase(),u=u.toLowerCase()),-1===r[a]){if(i>u)return-1;if(i<u)return 1}else{if(i>u)return 1;if(i<u)return-1}}});for(const e of a)o[e]=t[e];return o},paginate({data:t=e.data,total:r,limit:n=10,skip:o=0}){n=+n,o=+o;const a=Object.keys(t);r=r||a.length;const i={},u=n+o;for(let e=o;e<u;e++){const r=a[e];if(!r)break;i[r]=t[r]}return{total:r,limit:n,skip:o,data:i}},find({query:t={},map:r,...o}){const a=t,i={};let c=0;r=r||(e=>e);for(const t in e.data){const o=e.data[t];if("function"==typeof a)a(o)&&(c+=1,i[t]=r(o));else{let e=0,u=0;for(const t in a)e+=1,n(o,t)===a[t]&&(u+=1);u===e&&(c+=1,i[t]=r(o))}}return u?this.paginate({total:c,data:i,...o}):i}}}},function(e,t){let r=(e,t)=>"string"==typeof e||"number"==typeof e?t(e.toString().toLowerCase()):null!==e&&"object"==typeof e?Object.values(e).some(e=>r(e,t)):Array.isArray(e)?e.some(e=>r(e,t)):void 0;e.exports=(e="",t)=>{let n="",o=0,a=e.toLowerCase().replace(/\s\s+/g," ").trim().split(" ");return r(t,e=>{if(n=n+" "+e,o=((e,t)=>{let r=0;for(const n of e)t.indexOf(n)>-1&&(r+=1);return r})(a,n),o===a.length)return o}),{_score:o,...t}}},function(e,t){e.exports=require("fs")},function(e,t){e.exports=require("path")},function(e,t){e.exports=({app:e,url:t,hooks:r=((e,t)=>({before:{all:[],get:[],find:[],create:[],patch:[],remove:[]},after:{all:[],get:[],find:[],create:[],patch:[],remove:[]}}))},n)=>{const{before:o,after:a}=r({app:e,service:n}),i=(e,t)=>{for(let e=0;e<a.all.length;e++)t=a.all[e](t);for(let r=0;r<a[e].length;r++)t=a[e][r](t);return t};e.post(t,[...o.all,...o.create,(e,t,r)=>{let o=n.create(e.body);o=i("create",o),t.json(o)}]),e.get(t+"/:_id",[...o.all,...o.get,(e,t,r)=>{let o=n.get(e.params._id,e.query.$map);o=i("get",o),t.json(o)}]),e.patch(t+"/:_id",[...o.all,...o.patch,(e,t,r)=>{const o=e.params._id;let a=null;console.log(e.body);let{$action:u,...c}=e.body;u?(console.log(u,c),a=n[u](o,c),console.log(a)):a=n.patch(o,e.body),a=i("patch",a),t.json(a)}]),e.delete(t+"/:_id",[...o.all,...o.patch,(e,t,r)=>{let o=n.remove(e.params._id);o=i("remove",o),t.json(o)}]),e.get(t,[...o.all,...o.find,(e,t,r)=>{console.log("test2");let o=null;const a={query:{}};a.limit=e.query.$limit,a.skip=e.query.$skip,a.map=e.query.$map,delete e.query.$limit,delete e.query.$skip,delete e.query.$map,e.query.$search?o=n.search(e.query.$search,a):(a.query=e.query,o=n.find(a)),t.json(o)}])}}])}));